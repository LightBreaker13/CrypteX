#include "font8x16.h"
#include "common.h"

uint8_t font8x16[256][16];

#define ROWS8(a,b,c,d,e,f,g,h) {a,b,c,d,e,f,g,h,0,0,0,0,0,0,0,0}

typedef struct {
    char ch;
    uint8_t rows[16];
} glyph_def_t;

static const glyph_def_t glyphs[] = {
    {' ', ROWS8(0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)},
    {'0', ROWS8(0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0x00)},
    {'1', ROWS8(0x18,0x38,0x18,0x18,0x18,0x18,0x3C,0x00)},
    {'2', ROWS8(0x3C,0x66,0x06,0x0C,0x30,0x60,0x7E,0x00)},
    {'3', ROWS8(0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00)},
    {'4', ROWS8(0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00)},
    {'5', ROWS8(0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00)},
    {'6', ROWS8(0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0x00)},
    {'7', ROWS8(0x7E,0x06,0x0C,0x18,0x30,0x30,0x30,0x00)},
    {'8', ROWS8(0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00)},
    {'9', ROWS8(0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0x00)},
    {'A', ROWS8(0x18,0x24,0x42,0x42,0x7E,0x42,0x42,0x00)},
    {'B', ROWS8(0x7C,0x42,0x42,0x7C,0x42,0x42,0x7C,0x00)},
    {'C', ROWS8(0x3C,0x42,0x40,0x40,0x40,0x42,0x3C,0x00)},
    {'D', ROWS8(0x78,0x44,0x42,0x42,0x42,0x44,0x78,0x00)},
    {'E', ROWS8(0x7E,0x40,0x40,0x7C,0x40,0x40,0x7E,0x00)},
    {'F', ROWS8(0x7E,0x40,0x40,0x7C,0x40,0x40,0x40,0x00)},
    {'G', ROWS8(0x3C,0x42,0x40,0x4E,0x42,0x46,0x3C,0x00)},
    {'H', ROWS8(0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x00)},
    {'I', ROWS8(0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00)},
    {'J', ROWS8(0x0E,0x04,0x04,0x04,0x44,0x44,0x38,0x00)},
    {'K', ROWS8(0x42,0x44,0x48,0x70,0x48,0x44,0x42,0x00)},
    {'L', ROWS8(0x40,0x40,0x40,0x40,0x40,0x40,0x7E,0x00)},
    {'M', ROWS8(0x42,0x66,0x5A,0x5A,0x42,0x42,0x42,0x00)},
    {'N', ROWS8(0x42,0x62,0x52,0x4A,0x46,0x42,0x42,0x00)},
    {'O', ROWS8(0x3C,0x42,0x42,0x42,0x42,0x42,0x3C,0x00)},
    {'P', ROWS8(0x7C,0x42,0x42,0x7C,0x40,0x40,0x40,0x00)},
    {'Q', ROWS8(0x3C,0x42,0x42,0x42,0x4A,0x44,0x3A,0x00)},
    {'R', ROWS8(0x7C,0x42,0x42,0x7C,0x48,0x44,0x42,0x00)},
    {'S', ROWS8(0x3C,0x40,0x40,0x3C,0x02,0x02,0x3C,0x00)},
    {'T', ROWS8(0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00)},
    {'U', ROWS8(0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00)},
    {'V', ROWS8(0x42,0x42,0x42,0x24,0x24,0x24,0x18,0x00)},
    {'W', ROWS8(0x42,0x42,0x5A,0x5A,0x5A,0x66,0x42,0x00)},
    {'X', ROWS8(0x42,0x24,0x18,0x18,0x18,0x24,0x42,0x00)},
    {'Y', ROWS8(0x42,0x24,0x24,0x18,0x18,0x18,0x18,0x00)},
    {'Z', ROWS8(0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00)},
    {'-', ROWS8(0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00)},
    {'.', ROWS8(0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00)},
    {',', ROWS8(0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30)},
    {'/', ROWS8(0x02,0x04,0x08,0x10,0x20,0x40,0x80,0x00)},
    {':', ROWS8(0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00)},
    {'!', ROWS8(0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00)},
    {'?', ROWS8(0x3C,0x42,0x02,0x0C,0x10,0x00,0x10,0x00)},
    {'[', ROWS8(0x3C,0x20,0x20,0x20,0x20,0x20,0x3C,0x00)},
    {']', ROWS8(0x3C,0x04,0x04,0x04,0x04,0x04,0x3C,0x00)},
    {'<', ROWS8(0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x00)},
    {'>', ROWS8(0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x00)},
    {'=', ROWS8(0x00,0x7E,0x00,0x7E,0x00,0x00,0x00,0x00)}
};

void font8x16_init(void) {
    uint8_t defined[256];
    kmemset(defined, 0, sizeof(defined));
    kmemset(font8x16, 0, sizeof(font8x16));

    for (size_t i = 0; i < ARRAY_SIZE(glyphs); ++i) {
        uint8_t idx = (uint8_t)glyphs[i].ch;
        for (int row = 0; row < 16; ++row) {
            font8x16[idx][row] = glyphs[i].rows[row];
        }
        defined[idx] = 1;
    }

    for (int ch = 0; ch < 256; ++ch) {
        if (defined[ch]) {
            continue;
        }
        for (int row = 0; row < 16; ++row) {
            uint8_t pattern = 0;
            if (row == 0 || row == 15) {
                pattern = 0xFF;
            } else if (row % 2 == 0) {
                pattern = (uint8_t)((ch + row * 13) & 0xFF);
            } else {
                pattern = 0x81;
            }
            font8x16[ch][row] = pattern;
        }
    }
}

